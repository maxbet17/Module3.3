{"version":3,"file":"publish-controller.spec.js","sourceRoot":"","sources":["../../src/controller/publish-controller.spec.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport childProcess from 'child_process';\nimport fs from 'fs';\nimport os from 'os';\nimport path from 'path';\nimport {promisify} from 'util';\nimport {parseProjectManifest, ReaderFactory} from '@subql/common';\nimport {create} from 'ipfs-http-client';\nimport rimraf from 'rimraf';\nimport Build from '../commands/build';\nimport Codegen from '../commands/codegen';\nimport {isProjectSpecV0_0_1, ProjectSpecBase, ProjectSpecV0_0_1, ProjectSpecV0_2_0} from '../types';\nimport {cloneProjectGit, prepare} from './init-controller';\nimport {uploadFile, uploadToIpfs} from './publish-controller';\n\nconst projectSpecV0_0_1: ProjectSpecV0_0_1 = {\n  name: 'mocked_starter',\n  repository: '',\n  endpoint: 'wss://rpc.polkadot.io/public-ws',\n  author: 'jay',\n  description: 'this is test for init controller',\n  version: '',\n  license: '',\n};\n\nconst projectSpecV0_2_0: ProjectSpecV0_2_0 = {\n  name: 'mocked_starter',\n  repository: '',\n  genesisHash: '0x91b171bb158e2d3848fa23a9f1c25182fb8e20313b2c1eb49219da7a70ce90c3',\n  endpoint: 'wss://rpc.polkadot.io/public-ws',\n  author: 'jay',\n  description: 'this is test for init controller',\n  version: '',\n  license: '',\n};\n\nconst ipfsEndpoint = 'http://localhost:5001/api/v0';\n//Replace your access token before test\nconst testAuth = 'MTA0MzE2NTc=JIwMq1cCzGIWddlskYRE';\n\njest.setTimeout(120000);\n\nasync function createTestProject(projectSpec: ProjectSpecBase): Promise<string> {\n  const tmpdir = await fs.promises.mkdtemp(`${os.tmpdir()}${path.sep}`);\n  const projectDir = path.join(tmpdir, projectSpec.name);\n\n  const branch = isProjectSpecV0_0_1(projectSpec) ? 'v0.0.1' : 'v0.2.0';\n  const projectPath = await cloneProjectGit(\n    tmpdir,\n    projectSpec.name,\n    'https://github.com/subquery/subql-starter',\n    branch\n  );\n  await prepare(projectPath, projectSpec);\n\n  // Install dependencies\n  childProcess.execSync(`npm i`, {cwd: projectDir});\n\n  await Codegen.run(['-l', projectDir]);\n  await Build.run(['-l', projectDir]);\n\n  return projectDir;\n}\n\ndescribe('Cli publish', () => {\n  let projectDir: string;\n\n  afterEach(async () => {\n    try {\n      await promisify(rimraf)(projectDir);\n    } catch (e) {\n      console.warn('Failed to clean up tmp dir after test');\n    }\n  });\n\n  it('should not allow uploading a v0.0.1 spec version project', async () => {\n    projectDir = await createTestProject(projectSpecV0_0_1);\n    await expect(uploadToIpfs('', ipfsEndpoint, projectDir)).rejects.toBeDefined();\n  });\n\n  it(`upload file to ipfs`, async () => {\n    // only enable when test locally\n    const ipfs = create({url: ipfsEndpoint});\n    //test string\n    const cid = await uploadFile('Test for upload string to ipfs', testAuth);\n    console.log(`upload file cid: ${cid}`);\n    // test fs stream (project)\n    projectDir = await createTestProject(projectSpecV0_2_0);\n    const fsStream = fs.createReadStream(path.resolve(projectDir, 'project.yaml'));\n    const cid2 = await uploadFile(fsStream, testAuth);\n    console.log(`upload file cid: ${cid2}`);\n  });\n\n  it('should upload appropriate project to IPFS', async () => {\n    projectDir = await createTestProject(projectSpecV0_2_0);\n    const cid = await uploadToIpfs(projectDir, testAuth);\n    expect(cid).toBeDefined();\n    // validation no longer required, as it is deployment object been published\n    // await expect(Validate.run(['-l', cid, '--ipfs', ipfsEndpoint])).resolves.toBe(undefined);\n  });\n\n  it('should not allow uploading a v0.0.1 spec version project', async () => {\n    projectDir = await createTestProject(projectSpecV0_0_1);\n\n    await expect(uploadToIpfs('', ipfsEndpoint, projectDir)).rejects.toBeDefined();\n  });\n\n  it('throw error when v0.0.1 try to deploy', async () => {\n    projectDir = await createTestProject(projectSpecV0_0_1);\n    const reader = await ReaderFactory.create(projectDir);\n    const manifest = parseProjectManifest(await reader.getProjectSchema()).asImpl;\n    expect(() => manifest.toDeployment()).toThrowError(\n      'Manifest spec 0.0.1 is not support for deployment, please migrate to 0.2.0 or above'\n    );\n  });\n\n  it('convert to deployment and removed descriptive field', async () => {\n    projectDir = await createTestProject(projectSpecV0_2_0);\n    const reader = await ReaderFactory.create(projectDir);\n    const manifest = parseProjectManifest(await reader.getProjectSchema()).asImpl;\n    const deployment = manifest.toDeployment();\n    expect(deployment).not.toContain('name');\n    expect(deployment).not.toContain('author');\n    expect(deployment).not.toContain('endpoint');\n    expect(deployment).not.toContain('dictionary');\n    expect(deployment).not.toContain('description');\n    expect(deployment).not.toContain('repository');\n\n    expect(deployment).toContain('genesisHash');\n    expect(deployment).toContain('specVersion');\n    expect(deployment).toContain('dataSources');\n  });\n});\n"]}