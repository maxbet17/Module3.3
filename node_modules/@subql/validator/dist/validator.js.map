{"version":3,"file":"validator.js","sourceRoot":"","sources":["../src/validator.ts"],"names":[],"mappings":";AAAA,gEAAgE;AAChE,sCAAsC;;;AAEtC,0CAAuH;AAEvH,mCAAuC;AASvC,MAAa,SAAS;IAMpB,YAA6B,MAAc,EAAmB,QAAgB;QAAjD,WAAM,GAAN,MAAM,CAAQ;QAAmB,aAAQ,GAAR,QAAQ,CAAQ;QAL7D,UAAK,GAAW,EAAE,CAAC;IAK6C,CAAC;IAHlF,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,QAAgB,EAAE,IAAoB;QACxD,OAAO,IAAI,SAAS,CAAC,MAAM,sBAAa,CAAC,MAAM,CAAC,QAAQ,EAAE,IAAI,CAAC,EAAE,QAAQ,CAAC,CAAC;IAC7E,CAAC;IAGD,OAAO,CAAC,GAAG,KAAa;QACtB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,CAAC;IAC5B,CAAC;IAED,KAAK,CAAC,kBAAkB;QACtB,MAAM,OAAO,GAAa,EAAE,CAAC;QAC7B,MAAM,CAAC,GAAG,EAAE,SAAS,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC,CAAC,CAAC;QAEnG,IAAI,CAAC,SAAS,EAAE;YACd,MAAM,IAAI,KAAK,CAAC,uDAAuD,CAAC,CAAC;SAC1E;QAED,OAAO,CAAC,IAAI,CAAC;YACX,IAAI,EAAE,mBAAmB;YACzB,WAAW,EAAE,6EAA6E;YAC1F,KAAK,EAAE,CAAC,CAAC,SAAS;YAClB,OAAO,EAAE,KAAK;SACf,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,IAAI,iCAAwB,CAAC,SAAqC,CAAC,CAAC;QAEnF,IAAI,MAAM,CAAC,QAAQ,EAAE;YACnB,OAAO,CAAC,IAAI,CAAC;gBACX,IAAI,EAAE,mBAAmB;gBACzB,WAAW,EAAE,6EAA6E;gBAC1F,KAAK,EAAE,CAAC,CAAC,GAAG;gBACZ,OAAO,EAAE,KAAK;aACf,CAAC,CAAC;SACJ;QAED,MAAM,GAAG,GAAY;YACnB,IAAI,EAAE;gBACJ,WAAW,EAAE,IAAI,CAAC,QAAQ;gBAC1B,GAAG;gBACH,MAAM;aACP;YACD,MAAM,EAAE,OAAO;YACf,MAAM,EAAE,IAAI,CAAC,MAAM;SACpB,CAAC;QAEF,KAAK,MAAM,CAAC,IAAI,IAAI,CAAC,KAAK,EAAE;YAC1B,MAAM,MAAM,GAAG;gBACb,IAAI,EAAE,CAAC,CAAC,IAAI;gBACZ,WAAW,EAAE,CAAC,CAAC,WAAW;gBAC1B,KAAK,EAAE,KAAK;gBACZ,OAAO,EAAE,KAAK;aACf,CAAC;YACF,IAAI,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,IAAI,KAAK,gBAAQ,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,MAAM,IAAI,CAAC,CAAC,IAAI,KAAK,gBAAQ,CAAC,MAAM,CAAC,EAAE;gBACxF,MAAM,CAAC,OAAO,GAAG,IAAI,CAAC;aACvB;iBAAM;gBACL,MAAM,CAAC,KAAK,GAAG,MAAM,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;aACtC;YACD,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;SACtB;QACD,OAAO,OAAO,CAAC;IACjB,CAAC;IAED,KAAK,CAAC,QAAQ;QACZ,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAChD,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;IACxC,CAAC;CACF;AArED,8BAqEC","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport {ProjectManifestVersioned, VersionedProjectManifest, Reader, ReaderFactory, ReaderOptions} from '@subql/common';\nimport {Context} from './context';\nimport {Rule, RuleType} from './rules';\n\nexport interface Report {\n  name: string;\n  skipped: boolean;\n  description: string;\n  valid: boolean;\n}\n\nexport class Validator {\n  private readonly rules: Rule[] = [];\n\n  static async create(location: string, opts?: ReaderOptions): Promise<Validator> {\n    return new Validator(await ReaderFactory.create(location, opts), location);\n  }\n  constructor(private readonly reader: Reader, private readonly location: string) {}\n\n  addRule(...rules: Rule[]): void {\n    this.rules.push(...rules);\n  }\n\n  async getValidateReports(): Promise<Report[]> {\n    const reports: Report[] = [];\n    const [pkg, rawSchema] = await Promise.all([this.reader.getPkg(), this.reader.getProjectSchema()]);\n\n    if (!rawSchema) {\n      throw new Error('Not a valid SubQuery project, project.yaml is missing');\n    }\n\n    reports.push({\n      name: 'project-yaml-file',\n      description: 'A valid `project.yaml` file must exist in the root directory of the project',\n      valid: !!rawSchema,\n      skipped: false,\n    });\n\n    const schema = new ProjectManifestVersioned(rawSchema as VersionedProjectManifest);\n\n    if (schema.isV0_0_1) {\n      reports.push({\n        name: 'package-json-file',\n        description: 'A valid `package.json` file must exist in the root directory of the project',\n        valid: !!pkg,\n        skipped: false,\n      });\n    }\n\n    const ctx: Context = {\n      data: {\n        projectPath: this.location,\n        pkg,\n        schema,\n      },\n      logger: console,\n      reader: this.reader,\n    };\n\n    for (const r of this.rules) {\n      const report = {\n        name: r.name,\n        description: r.description,\n        valid: false,\n        skipped: false,\n      };\n      if ((!pkg && r.type === RuleType.PackageJSON) || (!schema && r.type === RuleType.Schema)) {\n        report.skipped = true;\n      } else {\n        report.valid = await r.validate(ctx);\n      }\n      reports.push(report);\n    }\n    return reports;\n  }\n\n  async validate(): Promise<boolean> {\n    const reports = await this.getValidateReports();\n    return !reports.some((r) => !r.valid);\n  }\n}\n"]}